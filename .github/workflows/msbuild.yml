name: Build, Test, and Analyze

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # Path to the solution file relative to the root of the project.
  SOLUTION_FILE_PATH: .

  UNITY_SOLUTION_FILE_PATH: ./XLGearModifier.Gear/

  # Configuration type to build.
  # You can convert this to a build matrix if you need coverage of multiple configuration types.
  # https://docs.github.com/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
  BUILD_CONFIGURATION: Release
  
  package_path: "~/XLGearModifier_SDK.2.0.0.unitypackage"

jobs:
  build-unity-assemblies:
    name: Build XLGearModifier.Unity & XLGearModifier.Unity.Editor
    runs-on: windows-latest

    outputs:
      generate_unitypackage: ${{ steps.changes.outputs.files_changed }}
    
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Paths Changes Filter
      id: changes
      uses: dorny/paths-filter@v2.10.2
      with:
        filters: |
          files_changed:
            - 'XLGearModifier.Gear/Assets/Scripts/**'
            - 'XLGearModifier.Gear/Assets/Editor/**'

    - name: Build 
      if: steps.changes.outputs.files_changed == 'true'
      working-directory: ${{env.GITHUB_WORKSPACE}}
      shell: powershell
      run: |
        msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.UNITY_SOLUTION_FILE_PATH}}

    # Copy DLL(s) into References folder and into Unity proj
    # Commit them?

  create-unity-package:
    name: Create Unity Package
    runs-on: ubuntu-latest
    needs: build-unity-assemblies
    if: needs.build-unity-assemblies.outputs.generate_unitypackage == 'true'

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
      - uses: actions/setup-dotnet@v2
    
      # Install the packager. We are putting it outside the working directory so we dont include it by mistake
      - name: Install Unity Packager
        run: |
          git clone https://github.com/Lachee/Unity-Package-Exporter.git "../tools/unity-package-exporter"
          dotnet publish -c Release -o ../tools "../tools/unity-package-exporter/UnityPackageExporter"
          
      # Pack the assets
      - name: Package Project
        run: |
          echo "Creating package ${{env.package_path}}"
          dotnet ../tools/UnityPackageExporter.dll --input ./XLGearModifier.Gear/Aseets/XLGM_SDK/ --output ${{env.package_path}}
          
      # Upload artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v3.0.0
        with:
          name: XLGearModifier_SDK.2.0.0.unitypackage
          path: ${{env.package_path}}   
        
  build-asset-bundles:
    name: Build Asset Bundles
    runs-on: windows-latest
    needs: build-unity-assemblies

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    
  build:
    name: Build & Analyze Mod
    runs-on: windows-latest
    needs: [build-unity-assemblies, build-asset-bundles]
    if: always()

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
        
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1
      
    - name: Setup VSTest.console.exe
      uses: darenm/Setup-VSTest@v1
      
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 1.11
        
    - name: Cache SonarCloud packages
      uses: actions/cache@v1
      with:
        path: ~\sonar\cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar
        
    - name: Cache SonarCloud scanner
      id: cache-sonar-scanner
      uses: actions/cache@v1
      with:
        path: .\.sonar\scanner
        key: ${{ runner.os }}-sonar-scanner
        restore-keys: ${{ runner.os }}-sonar-scanner
        
    - name: Install SonarCloud scanner
      if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        New-Item -Path .\.sonar\scanner -ItemType Directory
        dotnet tool update dotnet-sonarscanner --tool-path .\.sonar\scanner

    - name: Restore NuGet packages
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}
      
    #- name: Start SonarCloud Analysis
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
    #    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #  run: .\.sonar\scanner\dotnet-sonarscanner begin /k:"MCBTay_XLGearModifier" /o:"mcbtay" /d:sonar.login="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /d:sonar.cs.vstest.reportsPaths="**/*.trx" /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"
        
    - name: MSBuild
      working-directory: ${{env.GITHUB_WORKSPACE}}
      shell: powershell
      run: |
        msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}
        
    #- name: Stop SonarScanner Analysis
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
    #    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #  run: .\.sonar\scanner\dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
      
